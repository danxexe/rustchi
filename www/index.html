<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>rustchi</title>
  </head>
  <body>
    <pre id="output_0"></pre>
    <pre id="output_1"></pre>
    <style>
      @font-face {
        font-family: 'FiraMono';
        src: url("FiraMonoNerdFont-Regular.otf") format('opentype');
      }
      body {
        color: white;
        background: black;
      }
      pre {
        font-family: 'FiraMono';
        line-height: 1.18em;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.2.1/ansi_up.min.js" type="text/javascript"></script>
    <script>
      let t = 0;
      let ansi = (new AnsiUp);

      let buffer = {
        active: 0,
        buffers: [
          {
            data: "",
            el: document.getElementById("output_0"),
          },
          {
            data: "",
            el: document.getElementById("output_1"),
          },
        ],
        write: function(data) {
          this.buffers[this.active].data += data;
        },
        swap: function() {
          this.active = +!this.active;
          this.buffers[this.active].data = "";
        },
        flush: function() {
          let buf = this.buffers[this.active];
          buf.el.innerHTML = buf.data;
        },
      };
      window.buffer = buffer;

      window.ansi_up = (data) => {
        if (data === "\x1B[1;1H") {
          buffer.swap();
        }
        t += 1;
        let html = ansi.ansi_to_html(data);
        buffer.write(html);
      }

      let flushed_t = 0;
      let flush = () => {
        if (flushed_t < t) {
          console.log("flush")
          // let output = document.getElementById("output");
          // output.innerHTML = buffer;
          buffer.flush();
          // window.scrollTo(0, document.body.scrollHeight);
        }
        flushed_t = t;
        window.requestAnimationFrame(flush);
      }

      window.requestAnimationFrame(flush);
    </script>
    <script type="module">
        import init, { run  } from './rustchi-wasm/rustchi_wasm.js';

        (async () => {
            await init();
            console.log("starting emulator...");
            await run("https://f005.backblazeb2.com/file/danxexe/rustchi/rom.bin")
            console.log("done.");
        })()
      </script>
  </body>
</html>

#![allow(non_camel_case_types)]

use bitmatch::bitmatch;
use std::fmt;

use crate::immediate::*;
use crate::primitive::*;
use crate::registers::Reg;

#[derive(Clone)]
pub enum Opcode {
    PSET(u1, u4),
    JP(S),
    JP_C(S),
    JP_NC(S),
    JP_Z(S),
    JP_NZ(S),
    JP_BA,
    CALL(S),
    CALZ(S),
    RET,
    RETS,
    RETD(L),
    NOP5,
    NOP7,
    HALT,
    INC(Reg),
    LD(Reg, Source),
    LDPX(Reg, Source),
    LBPX(Source, Source),
    RST(u4),
    AND(Source, Source),
    ADD(Reg, Source),
    TODO(String),
    UNKNOWN,
}

#[bitmatch]
fn rq(r: u16) -> String {
    #[bitmatch]
    match r {
        "00" => format!("A"),
        "01" => format!("B"),
        "10" => format!("MX"),
        "11" => format!("MY"),
    }
}

impl Opcode {
    #[bitmatch]
    pub fn decode(instruction: u16) -> Opcode {
        use Opcode::*;
        #[bitmatch]
        match instruction {
            "0000_1110_010p_qqqq" => PSET(p.try_into().unwrap(), q.try_into().unwrap()),
            "0000_0000_ssss_ssss" => JP(s.into()),
            "0000_0010_ssss_ssss" => JP_C(s.into()),
            "0000_0011_ssss_ssss" => JP_NC(s.into()),
            "0000_0110_ssss_ssss" => JP_Z(s.into()),
            "0000_0111_ssss_ssss" => JP_NZ(s.into()),
            "0000_1111_1110_1000" => JP_BA,
            "0000_0100_ssss_ssss" => CALL(s.into()),
            "0000_0101_ssss_ssss" => CALZ(s.into()),
            "0000_1111_1101_1111" => RET,
            "0000_1111_1101_1110" => RETS,
            "0000_0001_llll_llll" => RETD(l.into()),
            "0000_1111_1111_1011" => NOP5,
            "0000_1111_1111_1111" => NOP7,
            "0000_1111_1111_1000" => HALT,
            "0000_1110_1110_0000" => INC(Reg::X),
            "0000_1110_1111_0000" => INC(Reg::Y),
            "0000_1011_xxxx_xxxx" => LD(Reg::X, Source::L(x.into())),
            "0000_1000_yyyy_yyyy" => LD(Reg::Y, Source::L(y.into())),
            "0000_1110_1000_00rr" => LD(Reg::XP, Source::Reg(r.into())),
            "0000_1110_1000_01rr" => TODO(format!("LD XH {}", rq(r))),
            "0000_1110_1000_10rr" => TODO(format!("LD XL {}", rq(r))),
            "0000_1110_1001_00rr" => LD(Reg::YP, Source::Reg(r.into())),
            "0000_1110_1001_01rr" => TODO(format!("LD YH {}", rq(r))),
            "0000_1110_1001_10rr" => TODO(format!("LD YL {}", rq(r))),
            "0000_1110_1010_00rr" => TODO(format!("LD {} XP", rq(r))),
            "0000_1110_1010_01rr" => TODO(format!("LD {} XH", rq(r))),
            "0000_1110_1010_10rr" => TODO(format!("LD {} XL", rq(r))),
            "0000_1110_1011_00rr" => TODO(format!("LD {} YP", rq(r))),
            "0000_1110_1011_01rr" => TODO(format!("LD {} YH", rq(r))),
            "0000_1110_1011_10rr" => TODO(format!("LD {} YL", rq(r))),
            "0000_1010_0000_iiii" => TODO(format!("ADC XH 0x{:01X}", i)),
            "0000_1010_0001_iiii" => TODO(format!("ADC XL 0x{:01X}", i)),
            "0000_1010_0010_iiii" => TODO(format!("ADC YH 0x{:01X}", i)),
            "0000_1010_0011_iiii" => TODO(format!("ADC YL 0x{:01X}", i)),
            "0000_1010_0100_iiii" => TODO(format!("CP XH 0x{:01X}", i)),
            "0000_1010_0101_iiii" => TODO(format!("CP XL 0x{:01X}", i)),
            "0000_1010_0110_iiii" => TODO(format!("CP YH 0x{:01X}", i)),
            "0000_1010_0111_iiii" => TODO(format!("CP YL 0x{:01X}", i)),
            "0000_1110_00rr_iiii" => LD(Reg::from(r), Source::U4(i.try_into().unwrap())),
            "0000_1110_1100_rrqq" => LD(r.into(), Source::Reg(q.into())),
            "0000_1111_1010_nnnn" => TODO(format!("LD A MN 0x{:01X}", n)),
            "0000_1111_1011_nnnn" => TODO(format!("LD B MN 0x{:01X}", n)),
            "0000_1111_1000_nnnn" => TODO(format!("LD MN A 0x{:01X}", n)),
            "0000_1111_1001_nnnn" => TODO(format!("LD MN B 0x{:01X}", n)),
            "0000_1110_0110_iiii" => LDPX(Reg::MX, Source::U4(i.try_into().unwrap())),
            "0000_1110_1110_rrqq" => TODO(format!("LDPX {} {}", rq(r), rq(q))),
            "0000_1110_0111_iiii" => TODO(format!("LDPY MY 0x{:01X}", i)),
            "0000_1110_1111_rrqq" => TODO(format!("LDPY {} {}", rq(r), rq(q))),
            "0000_1001_iiii_jjjj" => LBPX(Source::U4(u4![i]), Source::U4(u4![j])),
            "0000_1111_0100_iiii" => TODO(format!("SET 0x{:01X}", i)),
            "0000_1111_0101_iiii" => RST(i.try_into().unwrap()),
            "0000_1111_0100_0001" => TODO(format!("SCF")),
            "0000_1111_0101_1110" => TODO(format!("RCF")),
            "0000_1111_0100_0010" => TODO(format!("SZF")),
            "0000_1111_0101_1101" => TODO(format!("RZF")),
            "0000_1111_0100_0100" => TODO(format!("SDF")),
            "0000_1111_0101_1011" => TODO(format!("RDF")),
            "0000_1111_0100_1000" => TODO(format!("EI")),
            "0000_1111_0101_0111" => TODO(format!("DI")),
            "0000_1111_1101_1011" => TODO(format!("INC SP")),
            "0000_1111_1100_1011" => TODO(format!("DEC SP")),
            "0000_1111_1100_00rr" => TODO(format!("PUSH {}", rq(r))),
            "0000_1111_1100_0100" => TODO(format!("PUSH XP")),
            "0000_1111_1100_0101" => TODO(format!("PUSH XH")),
            "0000_1111_1100_0110" => TODO(format!("PUSH XL")),
            "0000_1111_1100_0111" => TODO(format!("PUSH YP")),
            "0000_1111_1100_1000" => TODO(format!("PUSH YH")),
            "0000_1111_1100_1001" => TODO(format!("PUSH YL")),
            "0000_1111_1100_1010" => TODO(format!("PUSH F")),
            "0000_1111_1101_00rr" => TODO(format!("POP {}", rq(r))),
            "0000_1111_1101_0100" => TODO(format!("POP XP")),
            "0000_1111_1101_0101" => TODO(format!("POP XH")),
            "0000_1111_1101_0110" => TODO(format!("POP XL")),
            "0000_1111_1101_0111" => TODO(format!("POP YP")),
            "0000_1111_1101_1000" => TODO(format!("POP YH")),
            "0000_1111_1101_1001" => TODO(format!("POP YL")),
            "0000_1111_1101_1010" => TODO(format!("POP F")),
            "0000_1111_1110_00rr" => LD(Reg::SPH, Source::Reg(r.into())),
            "0000_1111_1111_00rr" => LD(Reg::SPL, Source::Reg(r.into())),
            "0000_1111_1110_01rr" => TODO(format!("LD {} SPH", rq(r))),
            "0000_1111_1111_01rr" => TODO(format!("LD {} SPL", rq(r))),
            "0000_1100_00rr_iiii" => ADD(r.into(), Source::U4(u4![i])),
            "0000_1010_1000_rrqq" => TODO(format!("ADD {} {}", rq(r), rq(q))),
            "0000_1100_01rr_iiii" => TODO(format!("ADC {} 0x{:02X}", rq(r), i)),
            "0000_1010_1001_rrqq" => TODO(format!("ADC {} {}", rq(r), rq(q))),
            "0000_1010_1010_rrqq" => TODO(format!("SUB {} {}", rq(r), rq(q))),
            "0000_1011_01rr_iiii" => TODO(format!("SBC {} 0x{:02X}", rq(r), i)),
            "0000_1010_1011_rrqq" => TODO(format!("SBC {} {}", rq(r), rq(q))),
            "0000_1100_10rr_iiii" => AND(Source::Reg(r.into()), Source::U4(u4![i])),
            "0000_1010_1100_rrqq" => TODO(format!("AND {} {}", rq(r), rq(q))),
            "0000_1100_11rr_iiii" => TODO(format!("OR {} 0x{:02X}", rq(r), i)),
            "0000_1010_1101_rrqq" => TODO(format!("OR {} {}", rq(r), rq(q))),
            "0000_1101_00rr_iiii" => TODO(format!("XOR {} 0x{:02X}", rq(r), i)),
            "0000_1010_1110_rrqq" => TODO(format!("XOR {} {}", rq(r), rq(q))),
            "0000_1101_11rr_iiii" => TODO(format!("CP {} 0x{:02X}", rq(r), i)),
            "0000_1111_0000_rrqq" => TODO(format!("CP {} {}", rq(r), rq(q))),
            "0000_1101_10rr_iiii" => TODO(format!("FAN {} 0x{:02X}", rq(r), i)),
            "0000_1111_0001_rrqq" => TODO(format!("FAN {} {}", rq(r), rq(q))),
            "0000_1010_1111_rrbb" => TODO(format!("RLC {} {}", rq(r), rq(b))),
            "0000_1110_1000_11rr" => TODO(format!("RRC {}", rq(r))),
            "0000_1111_0110_nnnn" => TODO(format!("INC MN 0x{:01X}", n)),
            "0000_1111_0111_nnnn" => TODO(format!("DEC MN 0x{:01X}", n)),
            "0000_1111_0010_10rr" => TODO(format!("ACPX MX {}", rq(r))),
            "0000_1111_0010_11rr" => TODO(format!("ACPY MY {}", rq(r))),
            "0000_1111_0011_10rr" => TODO(format!("SCPX MX {}", rq(r))),
            "0000_1111_0011_11rr" => TODO(format!("SCPY MY {}", rq(r))),
            "0000_1101_00rr_1111" => TODO(format!("NOT {}", rq(r))),
            _ => UNKNOWN,
        }
    }
}

impl fmt::Display for Opcode {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        use Opcode::*;
        match self {
            PSET(p, q) => write!(f, "PSET {} {:#X}", p, q),
            JP(s) => write!(f, "JP {}", s),
            JP_C(s) => write!(f, "JP C {}", s),
            JP_NC(s) => write!(f, "JP NC {}", s),
            JP_Z(s) => write!(f, "JP Z {}", s),
            JP_NZ(s) => write!(f, "JP NZ {}", s),
            JP_BA => write!(f, "JP BA"),
            CALL(s) => write!(f, "CALL {}", s),
            CALZ(s) => write!(f, "CALZ {}", s),
            RET => write!(f, "RET"),
            RETS => write!(f, "RETS"),
            RETD(l) => write!(f, "RETD {}", l),
            NOP5 => write!(f, "NOP5"),
            NOP7 => write!(f, "NOP7"),
            HALT => write!(f, "HALT"),
            INC(r) => write!(f, "INC {}", r),
            LD(r, l) => write!(f, "LD {} {}", r, l),
            LDPX(r, i) => write!(f, "LDPX {} {}", r, i),
            LBPX(i, j) => write!(f, "LBPX {} {}", i, j),
            RST(i) => write!(f, "RST {}", i),
            AND(r, i) => write!(f, "AND {} {}", r, i),
            ADD(r, i) => write!(f, "ADD {} {}", r, i),
            TODO(s) => write!(f, "{} #TODO", s),
            UNKNOWN => write!(f, "??"),
        }
    }
}
